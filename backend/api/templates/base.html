{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block extra_head %}
      <meta name="turbolinks-cache-control" content="no-cache">
    {% endblock %}
    <title>{% block page_title %}Protask{% endblock %}</title>
    {% include 'partials/headers.html' %}
    {% include 'partials/navbar.html' %}
    {%block addition_css%}{%endblock%}
    <link rel="stylesheet" href="{% static 'css/bulma-0.7.4.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bulma-calendar.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bulma-tagsinput.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bulma-checkradio.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/default.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
      nav div.level-item.bulk-action { visibility: hidden; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script defer src="{% static 'js/turbolinks.js' %}"></script>
    <script defer src="{% static 'js/fetch.js' %}"></script>
  </head>
  <body>
    {% if user.is_authenticated %}
    <div class="container-fluid">
      <div class="row flex-nowrap">
          <div class="col-auto col py-3 col-md-2 col-xl-2 px-sm-2 px-2">
              {% include "partials/sidebar.html" %}
          </div>
          <div class="col py-3">
            {% block content %}
            {% endblock %}
          </div>
      </div>
  </div>
    {% endif %}


{% include 'partials/footer.html' %}
  </body>

  <script defer src="{% static 'js/bulma-calendar.min.js' %}" data-mutate-approach="sync"></script>
  <script defer src="{% static 'js/bulma-tagsinput.min.js' %}" data-mutate-approach="sync"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js" data-mutate-approach="sync"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
  <script>
    function ready(fn) {
      if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading"){
        fn();
      } else {
        document.addEventListener('DOMContentLoaded', fn);
      }
    }

    ready(function() {
      var elementList = document.querySelectorAll('a.launch-modal');
      Array.prototype.forEach.call(elementList, function(el, i) {
        el.addEventListener('click', function(event) {
          event.preventDefault()

          var modalFormTitle = document.querySelector('#modal-form .modal-card-title');
          modalFormTitle.innerHTML = event.target.textContent;

          var modalForm = document.querySelector('#modal-form');
          modalForm.querySelector('iframe').setAttribute('src', event.target.parentNode.getAttribute('href'));
          modalForm.classList.add('is-clipped');
          modalForm.classList.add('is-active');
        });
      });

      var elementList = document.querySelectorAll('#modal-form button');
      Array.prototype.forEach.call(elementList, function(el, i) {
        el.addEventListener('click', function(event) {
          var modalForm = document.querySelector('#modal-form');
          modalForm.classList.remove('is-active');
          modalForm.classList.remove('is-clipped');
        });
      });

      (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
        $notification = $delete.parentNode;
        $delete.addEventListener('click', () => {
          $notification.parentNode.removeChild($notification);
        });
      });

      bulmaTagsinput.attach('[data-tagulous="true"]');
      bulmaCalendar.attach('#id_starts_at', {type: 'date'});
      bulmaCalendar.attach('#id_ends_at', {type: 'date'});

      document.querySelectorAll('input[type="checkbox"].selectAll').forEach((selectAll) => {
        selectAll.addEventListener('click', function(event) {
          table = event.target.parentNode.parentNode.parentNode.parentNode;
          table.querySelectorAll('tbody input[type="checkbox"]').forEach(($checkbox) => {
            if (event.target.checked) {
              $checkbox.checked = true;
              document.querySelectorAll('.bulk-action').forEach(($div) => {
                $div.style.visibility = 'visible'
              });
            } else {
              $checkbox.checked = false;
              document.querySelectorAll('.bulk-action').forEach(($div) => {
                $div.style.visibility = 'hidden'
              });
            }
          })
        });
      });

      document.querySelectorAll('input[type="checkbox"]').forEach(($checkbox) => {
        $checkbox.addEventListener('click', function(event) {
          if (document.querySelectorAll('input[type="checkbox"]:checked').length > 0) {
            document.querySelectorAll('.bulk-action').forEach(($div) => {
              $div.style.visibility = 'visible'
            });
          } else {
            document.querySelectorAll('.bulk-action').forEach(($div) => {
              $div.style.visibility = 'hidden'
            });
          }
        })
      });

      window.postForm = function(form, button) {
        var formData = new FormData(form);

        if (button) {
          formData.append(button.name, button.value);
        } else {
          if (form.id) {
            document.querySelectorAll('select[form=' + form.id + ']').forEach(($select) => {
              formData.append($select.name, $select.value);
            });
          }
        }

        var object = {};
        formData.forEach((value, key) => {
            // Reflect.has in favor of: object.hasOwnProperty(key)
            if(!Reflect.has(object, key)){
                object[key] = value;
                return;
            }
            if(!Array.isArray(object[key])){
                object[key] = [object[key]];
            }
            object[key].push(value);
        });
        var jsonParams = JSON.stringify(object);

        fetch(document.location.href, {
          method: 'POST',
          headers: {
            'X-Fetch': 'true',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'Content-Type': 'application/json'
          },
          body: jsonParams
        }).then(function(data) {
          return data.json();
        }).then(function(jsonResponse) {
          Turbolinks.visit(jsonResponse.url, { action: "replace" });
        }).catch(function(error) {
          console.log('request failed', error)
        })
      };

      document.querySelectorAll('button[data-next]').forEach(($button) => {
        $button.addEventListener('click', function(event) {
          $button.form.querySelector('#next').value = $button.dataset.next;
        });
      });

      document.querySelectorAll('div.bulk-action button[type="submit"]').forEach(($button) => {
        $button.addEventListener('click', function(event) {
          event.preventDefault();
          let clickedElement = event.target;
          if (clickedElement.tagName != 'BUTTON') {
            clickedElement = clickedElement.parentNode;
          }
          postForm(clickedElement.form, clickedElement);
        });
      });

      document.querySelectorAll('form').forEach(($form) => {
        if (!$form.hasAttribute('data-nofetch')) {
          $form.addEventListener('submit', function(event) {
            event.preventDefault();
            if (event.target.method.toLowerCase() == 'get') {
              let params = new URLSearchParams();
              params.append('q', document.querySelector('#id_q').value);

              const url = new URL(document.URL);
              let to = url.searchParams.get('to-project');
              if (to) params.append('to-project', to);

              Turbolinks.visit(document.location.pathname + "?" + params.toString());
            } else {
              postForm(event.target);
            }
          });
        }
      })
    });
  </script>
</html>